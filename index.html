<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Daily Task Tracker</title>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; background-color: #f8f8f8; }
    h1 { text-align: center; }
    #progressContainer {
        width: 100%;
        background-color: #ddd;
        border-radius: 20px;
        margin: 10px 0 20px;
        height: 25px;
        overflow: hidden;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
    }
    #progressBar {
        height: 100%;
        width: 0%;
        background-color: #4caf50;
        border-radius: 20px 0 0 20px;
        text-align: center;
        line-height: 25px;
        color: white;
        font-weight: bold;
        transition: width 0.3s ease;
        user-select: none;
    }
    table { width: 100%; border-collapse: collapse; background: white; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; vertical-align: top; }
    th { background-color: #eee; }
    textarea { width: 95%; height: 50px; resize: vertical; }
    .remark { background-color: #ffffcc; }
    .status-box {
        width: 30px; height: 30px; cursor: pointer;
        display: inline-block; border: 1px solid #888;
        position: relative;
    }
    #character { display: block; margin: 20px auto; max-width: 150px; }
    .controls { text-align: center; margin: 15px 0; }
    .controls button, .controls label {
        margin: 5px; padding: 8px 15px; background: #4caf50;
        color: white; border: none; border-radius: 4px; cursor: pointer;
    }
    .controls button:hover, .controls label:hover { background: #45a049; }
    label[for="importFile"] { background: #2196f3; }
    input[type="file"] { display: none; }
    .palette {
        display: none;
        position: absolute;
        top: 35px;
        left: 0;
        background: white;
        border: 1px solid #ccc;
        padding: 5px;
        border-radius: 4px;
        z-index: 10;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .color-option {
        width: 20px; height: 20px;
        display: inline-block; cursor: pointer;
        border: 1px solid #333; margin: 2px; border-radius: 3px;
    }
</style>
</head>
<body>

<h1>Daily Task Tracker</h1>

<!-- Progress bar container -->
<div id="progressContainer" aria-label="Progress bar">
    <div id="progressBar">0%</div>
</div>

<img id="character" src="stage1.png" alt="Progress Character">

<div class="controls">
    <button id="exportBtn">⬇ Export Data</button>
    <label for="importFile">⬆ Import Data</label>
    <input type="file" id="importFile" accept=".json" />
</div>

<table id="taskTable">
    <thead>
        <tr>
            <th>Date</th>
            <th>Task</th>
            <th>Progress</th>
            <th>Status</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
const startDate = new Date(2025, 7, 13);
const endDate = new Date(2026, 1, 1);
let savedData = JSON.parse(localStorage.getItem('tasks') || '{}');
const tbody = document.querySelector("#taskTable tbody");
const progressBar = document.getElementById("progressBar");
const COLORS = ["green", "red"]; // only green and red allowed
let dayCount = 0;

function saveData() {
    localStorage.setItem('tasks', JSON.stringify(savedData));
    updateCharacter();
    updateProgressBar();
}

for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
    dayCount++;

    if (d.getDay() === 0) {
        let row = tbody.insertRow();
        row.classList.add("remark");
        row.insertCell().textContent = "Remark:";
        let remarkCell = row.insertCell();
        remarkCell.colSpan = 3;
        let remarkBox = document.createElement("textarea");
        remarkBox.value = savedData[`remark-${dayCount}`] || "";
        remarkBox.oninput = () => {
            savedData[`remark-${dayCount}`] = remarkBox.value;
            saveData();
        };
        remarkCell.appendChild(remarkBox);
    }

    let tr = tbody.insertRow();
    tr.insertCell().textContent = d.toLocaleDateString();

    let task = document.createElement("textarea");
    task.value = savedData[`task-${dayCount}`] || "";
    task.oninput = () => { savedData[`task-${dayCount}`] = task.value; saveData(); };
    tr.insertCell().appendChild(task);

    let prog = document.createElement("textarea");
    prog.value = savedData[`prog-${dayCount}`] || "";
    prog.oninput = () => { savedData[`prog-${dayCount}`] = prog.value; saveData(); };
    tr.insertCell().appendChild(prog);

    let statusBox = document.createElement("div");
    statusBox.className = "status-box";
    statusBox.style.backgroundColor = savedData[`status-${dayCount}`] || "red";

    let palette = document.createElement("div");
    palette.className = "palette";
    COLORS.forEach(color => {
        let opt = document.createElement("div");
        opt.className = "color-option";
        opt.style.backgroundColor = color;
        opt.title = color;
        opt.onclick = e => {
            e.stopPropagation();
            statusBox.style.backgroundColor = color;
            savedData[`status-${dayCount}`] = color;
            saveData();
            palette.style.display = "none";
        };
        palette.appendChild(opt);
    });

    statusBox.onclick = e => {
        e.stopPropagation();
        document.querySelectorAll(".palette").forEach(p => { if (p !== palette) p.style.display = "none"; });
        palette.style.display = (palette.style.display === "block") ? "none" : "block";
    };
    document.body.addEventListener("click", () => { palette.style.display = "none"; });

    statusBox.appendChild(palette);
    tr.insertCell().appendChild(statusBox);
}

document.getElementById("exportBtn").onclick = () => {
    const blob = new Blob([JSON.stringify(savedData)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "task_backup.json";
    a.click();
    URL.revokeObjectURL(url);
};

document.getElementById("importFile").onchange = function(evt) {
    const file = evt.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            savedData = JSON.parse(e.target.result);
            localStorage.setItem('tasks', JSON.stringify(savedData));
            alert("✅ Data Imported! Reloading...");
            location.reload();
        } catch {
            alert("❌ Invalid JSON file");
        }
    };
    reader.readAsText(file);
};

function updateCharacter() {
    let totalDays = dayCount;
    let greenDays = 0;
    for (let i = 1; i <= dayCount; i++) {
        let val = savedData[`status-${i}`]?.toLowerCase();
        if (val === "green" || val === "#008000" || val === "#00ff00") {
            greenDays++;
        }
    }
    const ratio = totalDays > 0 ? greenDays / totalDays : 0;
    const img = document.getElementById("character");
    if (ratio === 1 && totalDays > 0) img.src = "stage5.png";
    else if (ratio > 0.75) img.src = "stage4.png";
    else if (ratio > 0.5) img.src = "stage3.png";
    else if (ratio > 0.25) img.src = "stage2.png";
    else img.src = "stage1.png";
}

function updateProgressBar() {
    let totalDays = dayCount;
    let greenDays = 0;
    for (let i = 1; i <= dayCount; i++) {
        let val = savedData[`status-${i}`]?.toLowerCase();
        if (val === "green" || val === "#008000" || val === "#00ff00") {
            greenDays++;
        }
    }
    const percent = totalDays > 0 ? Math.round((greenDays / totalDays) * 100) : 0;
    progressBar.style.width = percent + '%';
    progressBar.textContent = percent + '%';
}

// Initialize
updateCharacter();
updateProgressBar();

</script>

</body>
</html>
