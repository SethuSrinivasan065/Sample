<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Daily Task Tracker (Firebase)</title>
<style>
    body { font-family: Arial, sans-serif; background:#f8f8f8; margin:20px; }
    h1 { text-align: center; }
    #progressContainer { width:100%; background:#ddd; border-radius:20px; margin:10px 0 20px; height:25px; overflow:hidden; }
    #progressBar { height:100%; width:0%; background:#4caf50; color:#fff; text-align:center; line-height:25px; font-weight:bold; transition:width .3s; }
    table { width:100%; border-collapse: collapse; background:#fff; }
    th, td { border:1px solid #ccc; padding:8px; text-align:center; vertical-align:top; }
    th { background:#eee; }
    textarea { width:95%; height:50px; resize:vertical; }
    .remark { background:#ffffcc; }
    .status-box { width:30px; height:30px; border:1px solid #888; cursor:pointer; position:relative; display:inline-block; }
    #character { display:block; margin:20px auto; max-width:150px; }
    .controls { text-align:center; margin:15px 0; }
    .controls button, .controls label { margin:5px; padding:8px 15px; background:#4caf50; color:white; border:none; border-radius:4px; cursor:pointer; }
    .controls button:hover, .controls label:hover { background:#45a049; }
    label[for="importFile"] { background:#2196f3; }
    input[type="file"] { display:none; }
    .palette { display:none; position:absolute; top:35px; left:0; background:white; border:1px solid #ccc; padding:5px; border-radius:4px; z-index:10; }
    .color-option { width:20px; height:20px; border:1px solid #333; margin:2px; border-radius:3px; cursor:pointer; display:inline-block; }
</style>
</head>
<body>

<h1>Daily Task Tracker</h1>

<div id="progressContainer">
    <div id="progressBar">0%</div>
</div>

<img id="character" src="stage1.png" alt="Progress Character">

<div class="controls">
    <button id="saveBtn">üíæ Save Progress</button>
    <button id="exportBtn">‚¨á Export Data</button>
    <label for="importFile">‚¨Ü Import Data</label>
    <input type="file" id="importFile" accept=".json" />
</div>

<table id="taskTable">
    <thead>
        <tr>
            <th>Date</th>
            <th>Task</th>
            <th>Progress</th>
            <th>Status</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  databaseURL: "https://sample-7a294-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "YOUR_PROJECT",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
  appId: "YOUR_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const startDate = new Date(2025, 7, 13);
const endDate = new Date(2026, 1, 1);
const tbody = document.querySelector("#taskTable tbody");
const progressBar = document.getElementById("progressBar");
const COLORS = ["green", "red"]; 
let savedData = {};
let dayCount = 0;

function updateUIFromData(data) {
    savedData = data || {};
    tbody.innerHTML = "";
    dayCount = 0;

    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate()+1)) {
        dayCount++;

        // Sunday remark row
        if (d.getDay() === 0) {
            let row = tbody.insertRow();
            row.classList.add("remark");
            row.insertCell().textContent = "Remark:";
            let remarkCell = row.insertCell();
            remarkCell.colSpan = 3;
            let remarkBox = document.createElement("textarea");
            remarkBox.value = savedData[`remark-${dayCount}`] || "";
            remarkCell.appendChild(remarkBox);
        }

        let tr = tbody.insertRow();
        tr.insertCell().textContent = d.toLocaleDateString();

        let task = document.createElement("textarea");
        task.value = savedData[`task-${dayCount}`] || "";
        tr.insertCell().appendChild(task);

        let prog = document.createElement("textarea");
        prog.value = savedData[`prog-${dayCount}`] || "";
        tr.insertCell().appendChild(prog);

        let statusBox = document.createElement("div");
        statusBox.className = "status-box";
        statusBox.style.backgroundColor = savedData[`status-${dayCount}`] || "red";

        let palette = document.createElement("div");
        palette.className = "palette";
        COLORS.forEach(color => {
            let opt = document.createElement("div");
            opt.className = "color-option";
            opt.style.backgroundColor = color;
            opt.title = color;
            opt.onclick = e => {
                e.stopPropagation();
                statusBox.style.backgroundColor = color;
            };
            palette.appendChild(opt);
        });

        statusBox.onclick = e => {
            e.stopPropagation();
            document.querySelectorAll(".palette").forEach(p => { if (p !== palette) p.style.display = "none"; });
            palette.style.display = palette.style.display === "block" ? "none" : "block";
        };
        document.body.addEventListener("click", () => { palette.style.display = "none"; });

        statusBox.appendChild(palette);
        tr.insertCell().appendChild(statusBox);
    }

    updateCharacter();
    updateProgressBar();
}

function saveToFirebase() {
    // collect data from table
    let allRows = Array.from(tbody.rows);
    let counter = 0;
    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate()+1)) {
        counter++;
        if (d.getDay() === 0) {
            let remarkRow = allRows.shift();
            savedData[`remark-${counter}`] = remarkRow.cells[1]?.querySelector("textarea")?.value || "";
        }
        let row = allRows.shift();
        savedData[`task-${counter}`] = row.cells[1]?.querySelector("textarea")?.value || "";
        savedData[`prog-${counter}`] = row.cells[2]?.querySelector("textarea")?.value || "";
        savedData[`status-${counter}`] = row.cells[3]?.querySelector(".status-box")?.style.backgroundColor || "red";
    }
    set(ref(db, 'tasks'), savedData).then(() => alert("‚úÖ Progress saved online!"));
}

function loadFromFirebase() {
    get(ref(db, 'tasks')).then(snapshot => {
        updateUIFromData(snapshot.val());
    });
}

function updateCharacter() {
    let greenDays = 0;
    for (let i = 1; i <= dayCount; i++) {
        let val = (savedData[`status-${i}`] || "").toLowerCase();
        if (val === "green" || val === "#008000" || val === "#00ff00") greenDays++;
    }
    let ratio = greenDays / dayCount;
    const img = document.getElementById("character");
    if (ratio === 1 && dayCount > 0) img.src = "stage5.png";
    else if (ratio > 0.75) img.src = "stage4.png";
    else if (ratio > 0.5) img.src = "stage3.png";
    else if (ratio > 0.25) img.src = "stage2.png";
    else img.src = "stage1.png";
}

function updateProgressBar() {
    let greenDays = 0;
    for (let i = 1; i <= dayCount; i++) {
        let val = (savedData[`status-${i}`] || "").toLowerCase();
        if (val === "green" || val === "#008000" || val === "#00ff00") greenDays++;
    }
    let percent = Math.round((greenDays / dayCount) * 100);
    progressBar.style.width = percent + "%";
    progressBar.textContent = percent + "%";
}

// Event listeners
document.getElementById("saveBtn").onclick = saveToFirebase;
document.getElementById("exportBtn").onclick = () => {
    const blob = new Blob([JSON.stringify(savedData)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "task_backup.json";
    a.click();
    URL.revokeObjectURL(url);
};
document.getElementById("importFile").onchange = evt => {
    const file = evt.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        try {
            savedData = JSON.parse(e.target.result);
            updateUIFromData(savedData);
            saveToFirebase();
        } catch { alert("‚ùå Invalid file"); }
    };
    reader.readAsText(file);
};

// Load initially
loadFromFirebase();

</script>
</body>
</html>
